source('Caribbean_sizemodel_functions.r')
source('Caribbean_params.r')

params<-set_param()

refuges <- read.delim("data/Bonaire_refuges_DEC2015.txt", header = TRUE)

inverts <- read.delim("data/Kramer_invert_data.txt", header = TRUE)

#==============================
#Initial run without complexity
#==============================

#params$def.high = 0.4
#params$def.low = 0.4
#params$invert.prod = 2
#params$sinking.rate = 0.8
#params$pp = 0.5
#params$invert.prod = 2
#params$pref.pel = 0.33
#params$pref.herb = 0.17

#params$refuge <- c(rep(0, 135), rep(100, 31))
params$refuge <- rep(0, length(params$x))
initial.res <- run_model(params=params, initial.run = T)#, pred.stock.recruitment = F)

#Karpata example
params$refuge <- refuges[,5]
#Aquarius example
#params$refuge <- refuges[,14]
Karpata <- run_model(params=params, initial.run = T)

#------------
#Plot results
#------------
#Size spectra 
plotsizespectrum_full(initial.res, params)#, add.points = F)
points(log_abundance_m2~Mean.log10.weight, data = inverts, pch = 19, col = "brown")

plotsizespectrum_full(complex_check, params)#, add.points = F)
points(log_abundance_m2~Mean.log10.weight, data = inverts, pch = 19, col = "brown")

#Pareto size spectra
plotparetopreds_10(complex_check, params)
plotparetoherbs_10(complex_check, params)

#Biomass through time
plotbiomass(initial.res, params)

#Algae and herbivores through time
time <- seq(by = 1, length = params$N)
plot(complex_check$A_time~time, type = "l", ylim = c(0, 250), col = "seagreen", lwd = 2, main = "Algae and herbivores")#, xlim = c(0,50))
points(complex_check$h_bio_time~time, type = "l", col = "green")

time <- seq(by = 1, length = params$N)
plot(initial.res$A_time~time, type = "l", ylim = c(0, 250), col = "seagreen", lwd = 2, main = "Algae and herbivores", xlim = c(0,50))
points(initial.res$h_bio_time~time, type = "l", col = "green")


#Detritus and invertebrates through time
plot(initial.res$Det_time~time, type = "l", ylim = c(0, 100), col = "grey", lwd = 2, main = "Detritus and invertivores")#, xlim = c(0,50))
points(initial.res$i_bio_time~time, type = "l", col = "brown")

#Growth rates by size
compare_growth(initial.res, params)

#dev.off()

#Save size spectra data at end of run
saveendspectra(initial.res)
#Can then be read in as initial values for next model run 

#-------------------------------------------------------------
#Run model for each FORCE site
#-------------------------------------------------------------

#original refuges
#refuges <- read.delim("data/FORCE_refuge_ss_per_site.txt", header = TRUE)
#New refuges
#refuges <- read.delim("data/FORCE_refuge_ss_per_site_NEW.txt", header = TRUE)
refuge <-list(refuges[,2],refuges[,3],refuges[,4],refuges[,5],refuges[,6],refuges[,7],
              refuges[,8])

Fmort_pred <- 0 #c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5)
min.fishing.size <- 1# c(2,1,0)

simset<-data.frame(matrix(0,length(refuge)*length(Fmort_pred)*length(min.fishing.size),3))
names(simset)<-c("refuge", "Fmort_pred", "min.fishing.size")

simset$refuge <- rep(refuge, length(Fmort_pred))
simset$Fmort_pred <- rep(Fmort_pred, each = length(refuge))
simset$min.fishing.size <- rep(min.fishing.size, each = length(refuge)*length(Fmort_pred))


#Create dataframe to hold summary data
output <- data.frame(matrix(0, length(simset[,1]), 13))
names(output) <- c("Site_name", "Mod_pred_biomass","Mod_herb_biomass", "Mod_inv_biomass",
                   "Mod_pred_biomass_5", "Mod_herb_biomass_5", "Pred_prod", "Herb_prod", 
                   "Inv_prod", "Pred_Fprod", "Herb_Fprod", "net_algae", "net_detritus")

output$Site_name <- rep(names(refuges)[2:8], length(Fmort_pred))

time <- seq(by = 1, length = params$N)
count <- 1:length(simset[,1])

#Create lists to hold size spectra data
Pred_ss_dat <- list(1)
Herb_ss_dat <- list(1)
Inv_ss_dat <- list(1)

#Create lists to hold growth data
Pred_growth_data <- list(1)
Herb_growth_data <- list(1)
Inv_growth_data <- list(1)

#Create lists to hold mortality data
Pred_mort_data <- list(1)
Herb_mort_data <- list(1)
Inv_mort_data <- list(1)

Refuge_data <- list(1)

#params$tmaxyears = 50

#pdf("results/ideal_functions_Jan2016/Mar2nd_test_params/ss_and_growth_plots.pdf")
#pdf("results/July2016_fixed_inverts/ss_and_growth_plots.pdf")
pdf("results/Bonaire_comparison/Av01/ss_and_growth_plots.pdf")


#Run model for each refuge dataset
for (i in 1: length(simset[,1])){ 
#i = 1 
  params$refuge <- refuges[,i+1]
  
  res <- run_model(params = params, initial.run = F)
  
  output$Site_name[i] <- names(refuges)[i+1]
  
  #Info data
  output$pp[i] <- res$params$pp
  output$min.A[i] <- res$params$min.A
  
  #Total biomass data
  output$Mod_pred_biomass[i] <- res$Pred_gm
  output$Mod_herb_biomass[i] <- res$Herb_gm
  output$Mod_inv_biomass[i]  <- res$Inv_gm
  
  #Biomass data for fish greater than 5cm - or .... log10
  output$Mod_pred_biomass_5[i] <- res$Pred_dat_gm_5
  output$Mod_herb_biomass_5[i] <- res$Herb_dat_gm_5
  
  #Productivity
  output$Pred_prod[i] <- res$Pred_prod
  output$Herb_prod[i] <- res$Herb_prod
  output$Inv_prod[i]  <- res$Inv_prod
  
  output$Pred_Fprod[i] <- res$Fpred_prod
  output$Herb_Fprod[i] <- res$Fherb_prod
  
  output$Pred_Fprod_time[i] <- mean(res$FPred_prod_time[36500:73000])
  output$Herb_Fprod_time[i] <- mean(res$FHerb_prod_time[36500:73000])
  output$Inv_prod_time[i] <- mean(res$Inv_prod_time[36500:73000])
  
  #Algae and detritus
  output$net_algae[i] <- res$A
  output$net_detritus[i] <- res$W
  
  
  Pred_ss_dat[[i]] <- res$Preds
  Herb_ss_dat[[i]] <- res$Herbs
  Inv_ss_dat[[i]] <- res$Invs
  
  Pred_growth_data[[i]] <- res$P_grth
  Herb_growth_data[[i]] <- res$H_grth
  Inv_growth_data[[i]] <- res$I_grth
  
  Pred_mort_data[[i]] <- res$P_mrt
  Herb_mort_data[[i]] <- res$H_mrt
  Inv_mort_data[[i]] <- res$I_mrt
  
  Refuge_data[[i]] <- res$Pred_ref
  
  plotsizespectrum_full(res, params)
  text(2,15, count[i])
  
  plotbiomass(res, params)
  
  compare_growth(res, params)
  text(-2,4, count[i])
  
  plot(Pred_growth_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,2), main = "Predator growth"
       , col = "red")
  plot(Herb_growth_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,2), main = "Herbivore growth"
       , col = "green")
  plot(Inv_growth_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,3), main = "Invertebrate growth"
       , col = "brown")
  
  plot(Pred_mort_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,5), main = "Predator mortality"
       , col = "red")
  plot(Herb_mort_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,5), main = "Herbivore mortality"
       , col = "green")
  plot(Inv_mort_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,20), main = "Invertebrate 
       mortality", col = "brown")
  
  plot(Refuge_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,1), main = "Refuge"
       , col = "black")
  text(4,0.8, count[i])

  plot(res$A_time~time, type = "l", col = "seagreen", ylim = c(0, 250))
  points(res$h_bio_time~time, type = "l", col = "green")
  text(30000,100, count[i])
}

output

#write.table(output, "results/ideal_functions_Jan2016/Mar2nd_test_params/summary.txt", row.names = FALSE)
#write.table(output, "results/July2016_fixed_inverts/summary.txt", row.names = FALSE)
write.table(output, "results/Bonaire_comparison/Av01/summary.txt", row.names = FALSE)


#Unlist and re-structure size spectra data for further analyses
site <- unique(output$Site_name)
size <- params$x

location_info <- list(1)

for (i in 1: length(site)){
  location_info[[i]] <- rep(as.character(site[i]), length(params$x))
}

location_info <- unlist(location_info[-8])

#Abundance data
pred_data <- as.data.frame(cbind(location_info, unlist(Pred_ss_dat)))
names(pred_data) <- c("Site", "ss_data")
pred_data$size <- rep(size, length(site))
#write.table(pred_data, paste("results/ideal_functions_Jan2016/Mar2nd_test_params/preds.txt"))
write.table(pred_data, paste("results/Bonaire_comparison/Av01/preds.txt"))

herb_data <- as.data.frame(cbind(location_info, unlist(Herb_ss_dat)))
names(herb_data) <- c("Site", "ss_data")
herb_data$size <- rep(size, length(site))
#write.table(herb_data, paste("results/ideal_functions_Jan2016/Mar2nd_test_params/herbs.txt"))
write.table(herb_data, paste("results/Bonaire_comparison/Av01/herbs.txt"))

inv_data <- as.data.frame(cbind(location_info, unlist(Inv_ss_dat)))
names(inv_data) <- c("Site", "ss_data")
inv_data$size <- rep(size, length(site))
#write.table(inv_data, paste("results/ideal_functions_Jan2016/Mar2nd_test_params/invs.txt"))
write.table(inv_data, paste("results/Bonaire_comparison/Av01/invs.txt"))

#Growth data
G_pred_data <- as.data.frame(cbind(location_info, unlist(Pred_growth_data)))
names(G_pred_data) <- c("Site", "ss_data")
G_pred_data$size <- rep(size, length(site))
#write.table(G_pred_data, paste("results/ideal_functions_Jan2016/Mar2nd_test_params/GRWTH_preds.txt"))
write.table(G_pred_data, paste("results/Bonaire_comparison/Av01/GRWTH_preds.txt"))

G_herb_data <- as.data.frame(cbind(location_info, unlist(Herb_growth_data)))
names(G_herb_data) <- c("Site", "ss_data")
G_herb_data$size <- rep(size, length(site))
#write.table(G_herb_data, paste("results/ideal_functions_Jan2016/Mar2nd_test_params/GRWTH_herbs.txt"))
write.table(G_herb_data, paste("results/Bonaire_comparison/Av01/GRWTH_herbs.txt"))

G_inv_data <- as.data.frame(cbind(location_info, unlist(Inv_growth_data)))
names(G_inv_data) <- c("Site", "ss_data")
G_inv_data$size <- rep(size, length(site))
#write.table(G_inv_data, paste("results/ideal_functions_Jan2016/Mar2nd_test_params/GRWTH_invs.txt"))
write.table(G_inv_data, paste("results/Bonaire_comparison/Av01/GRWTH_invs.txt"))

Refuge_data <- as.data.frame(cbind(location_info, unlist(Refuge_data)))
names(Refuge_data) <- c("Site", "refs")
Refuge_data$size <- rep(size, length(site))
#write.table(Refuge_data, paste("results/ideal_functions_Jan2016/Mar2nd_test_params/refuges.txt"))
write.table(Refuge_data, paste("results/Bonaire_comparison/Av01/refuges.txt"))

#===========================================================================================================================================
#Effect of varying fishing at different complexity sites
#===========================================================================================================================================
refuge <-list(refuges[,2],refuges[,3],refuges[,4],refuges[,5],refuges[,6],refuges[,7],
              refuges[,8],refuges[,9],refuges[,10],refuges[,11],refuges[,12],refuges[,13]
              ,refuges[,14],refuges[,15],refuges[,16],refuges[,17],refuges[,18],refuges[,19]
              ,refuges[,20],refuges[,21],refuges[,22],refuges[,23],refuges[,24],refuges[,25]
              ,refuges[,26],refuges[,27],refuges[,28],refuges[,29],refuges[,30],refuges[,31]
              ,refuges[,32])

Fmort_pred <- 1.5#c(0.2,0.8,1.5)
min.fishing.size <- 1# c(2,1,0)

simset<-data.frame(matrix(0,length(refuge)*length(Fmort_pred)*length(min.fishing.size),3))
names(simset)<-c("refuge", "Fmort_pred", "min.fishing.size")

simset$refuge <- rep(refuge, length(Fmort_pred))
simset$Fmort_pred <- rep(Fmort_pred, each = length(refuge))
simset$min.fishing.size <- rep(min.fishing.size, each = length(refuge)*length(Fmort_pred))

output <- data.frame(matrix(0, length(refuges[1,]), 17))
names(output) <- c("Site_name", "Fmort","min.fishing.size","Mod_pred_biomass","Mod_herb_biomass", "Mod_inv_biomass",
                   "Mod_pred_biomass_5", "Mod_herb_biomass_5", "Pred_prod", "Herb_prod", 
                   "Inv_prod", "Pred_Fprod", "Herb_Fprod", "net_algae", "net_detritus",
                   "Pred_yield", "Herb_yield")

time <- seq(by = 1, length = params$N)
count <- 1:length(simset[,1])

#Create lists to hold size spectra data
Pred_ss_dat <- list(1)
Herb_ss_dat <- list(1)
Inv_ss_dat <- list(1)

#Create lists to hold growth data
Pred_growth_data <- list(1)
Herb_growth_data <- list(1)
Inv_growth_data <- list(1)

#Create lists to hold mortality data
Pred_mort_data <- list(1)
Herb_mort_data <- list(1)
Inv_mort_data <- list(1)

Refuge_data <- list(1)

params$tmaxyears = 50

pdf("results/FORCE_data_comparison/ss_and_growth_plots_with_fishing_15.pdf")

#Run model for each refuge dataset
for (i in 1: (length(simset[,1]))){ 
  #i = 1 
  params$refuge <- simset$refuge[[i]]
  params$Fmort_pred <- simset$Fmort_pred[i]
  params$min.fishing.size <- simset$min.fishing.size[i]
  
  params$Fmort_herb <- params$Fmort_pred
  
  res <- run_model(params = params, initial.run = F)
  
  output$Site_name[i] <- names(refuges)[i+1]
  
  #Info data
  output$Fmort[i] <- res$params$Fmort_pred
  output$min.fishing.size[i] <- res$params$min.fishing.size
  
  #Total biomass data
  output$Mod_pred_biomass[i] <- res$Pred_gm
  output$Mod_herb_biomass[i] <- res$Herb_gm
  output$Mod_inv_biomass[i]  <- res$Inv_gm
  
  #Biomass data for fish greater than 5cm - or .... log10
  output$Mod_pred_biomass_5[i] <- res$Pred_dat_gm_5
  output$Mod_herb_biomass_5[i] <- res$Herb_dat_gm_5
  
  #Productivity
  output$Pred_prod[i] <- res$Pred_prod
  output$Herb_prod[i] <- res$Herb_prod
  output$Inv_prod[i]  <- res$Inv_prod
  
  output$Pred_Fprod[i] <- res$Fpred_prod
  output$Herb_Fprod[i] <- res$Fherb_prod
  
  #Algae and detritus
  output$net_algae[i] <- res$A
  output$net_detritus[i] <- res$W
  
  #Catch
  output$Pred_yield[i] <- sum(res$Yield_p)
  output$Herb_yield[i] <- sum(res$Yield_h)
  
  Pred_ss_dat[[i]] <- res$Preds
  Herb_ss_dat[[i]] <- res$Herbs
  Inv_ss_dat[[i]] <- res$Invs
  
  Pred_growth_data[[i]] <- res$P_grth
  Herb_growth_data[[i]] <- res$H_grth
  Inv_growth_data[[i]] <- res$I_grth
  
  Pred_mort_data[[i]] <- res$P_mrt
  Herb_mort_data[[i]] <- res$H_mrt
  Inv_mort_data[[i]] <- res$I_mrt
  
  Refuge_data[[i]] <- res$Pred_ref
  
  plotsizespectrum_full(res, params)
  text(2,15, count[i])
  
  compare_growth(res, params)
  text(-2,4, count[i])
  
  plot(Pred_growth_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,2), main = "Predator growth"
       , col = "red")
  plot(Herb_growth_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,2), main = "Herbivore growth"
       , col = "green")
  plot(Inv_growth_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,3), main = "Invertebrate growth"
       , col = "brown")
  
  plot(Pred_mort_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,5), main = "Predator mortality"
       , col = "red")
  plot(Herb_mort_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,5), main = "Herbivore mortality"
       , col = "green")
  plot(Inv_mort_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,20), main = "Invertebrate 
       mortality", col = "brown")
  
  plot(Refuge_data[[i]]~params$x, type = "l", xlim = c(-1.5, 5), ylim = c(0,1), main = "Refuge"
       , col = "black")
  text(4,0.8, count[i])
  
  plot(res$A_time~time, type = "l", col = "seagreen", ylim = c(0, 250))
  points(res$h_bio_time~time, type = "l", col = "green")
  text(30000,100, count[i])
}

output

dev.off()


write.table(output, "results/FORCE_data_comparison/summary_FISHED_15.txt", row.names = FALSE)

site <- unique(output$Site_name)
size <- params$x

location_info <- list(1)

for (i in 1: length(site)){
  location_info[[i]] <- rep(as.character(site[i]), length(params$x))
}

location_info <- unlist(location_info[-32])

#Abundance data
pred_data <- as.data.frame(cbind(location_info, unlist(Pred_ss_dat)))
names(pred_data) <- c("Site", "ss_data")
pred_data$size <- rep(size, length(site)-1)
write.table(pred_data, paste("results/FORCE_data_comparison/preds_15.txt"))

herb_data <- as.data.frame(cbind(location_info, unlist(Herb_ss_dat)))
names(herb_data) <- c("Site", "ss_data")
herb_data$size <- rep(size, length(site)-1)
write.table(herb_data, paste("results/FORCE_data_comparison/herbs_15.txt"))

inv_data <- as.data.frame(cbind(location_info, unlist(Inv_ss_dat)))
names(inv_data) <- c("Site", "ss_data")
inv_data$size <- rep(size, length(site)-1)
write.table(inv_data, paste("results/FORCE_data_comparison/invs_15.txt"))

#Growth data
G_pred_data <- as.data.frame(cbind(location_info, unlist(Pred_growth_data)))
names(G_pred_data) <- c("Site", "ss_data")
G_pred_data$size <- rep(size, length(site)-1)
write.table(G_pred_data, paste("results/FORCE_data_comparison/GRWTH_preds_15.txt"))

G_herb_data <- as.data.frame(cbind(location_info, unlist(Herb_growth_data)))
names(G_herb_data) <- c("Site", "ss_data")
G_herb_data$size <- rep(size, length(site)-1)
write.table(G_herb_data, paste("results/FORCE_data_comparison/GRWTH_herbs_15.txt"))

G_inv_data <- as.data.frame(cbind(location_info, unlist(Inv_growth_data)))
names(G_inv_data) <- c("Site", "ss_data")
G_inv_data$size <- rep(size, length(site)-1)
write.table(G_inv_data, paste("results/FORCE_data_comparison/GRWTH_invs_15.txt"))

Refuge_data <- as.data.frame(cbind(location_info, unlist(Refuge_data)))
names(Refuge_data) <- c("Site", "refs")
Refuge_data$size <- rep(size, length(site)-1)
write.table(Refuge_data, paste("results/FORCE_data_comparison/refuges_15.txt"))
